<!DOCTYPE html>
<html>
<head>
<title>Memoframe Replay</title>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<style>
html, body
{
  height: 100%;
  margin: 0px;
  padding: 0px;
  border: 0px;
  overflow: auto;
}

iframe
{
  width: 100%;
  height: 100%;
  overflow: hidden;
}

.frame_div {
  position: absolute;
  padding-top: 50px; 
  width: 100%;
  height: 100%;
  overflow: hidden;
}
  

.header
{
  text-align: center;
  padding: 8px;
  font-size: 20px;
}

.header * {
  font-size: 20px;
}

.rel_message {
  font-size: 16px;
  color: red;
  font-style: italic;
  display: none;
}

</style>
</head>
<body>
<div class="header">
Date/Time:
<input id="ts" type="text" value="{{ ts }}"></input>
<input id="update" type="button" value="Update"></input><div class="rel_message">Date/time set, please click "reload" or "refresh" in the browser below.</div>
</div>
<div id="currLabel" class="header">
Loading <b>{{url}}</b>
</div>
<iframe seamless="seamless" frameborder="0" scrolling="no"></iframe>
<script>

$(function() {
    window.frames[0].focus();

    var coll = "{{ coll }}";
    var url = "{{ url }}";
    var curr_ts = "{{ ts }}";

    window.setTimeout(function() {
        document.querySelector("iframe").src = "http://{{ vnc_host }}/vnc_auto.html?password=secret";
    }, 1000);

    $("#update").click(function() {
        var ts = $("#ts").val();

        var cmd_url = "http://{{ cmd_host }}/set?ts=" + ts;

        $.getJSON(cmd_url, function(data) {
            if (data && data.success) {
                curr_ts = ts;
                console.log("Updated Date to " + ts);
                $(".rel_message").show();
                update_state();
            }
        });

        window.frames[0].focus();
    });

    function update_state() {
        var full_url = "/" + coll + "/" + curr_ts + "/" + url;

        window.history.replaceState({}, "", full_url);
    }

    function ping() {
        $.getJSON("http://{{ cmd_host }}/ping?ts=" + curr_ts, function(data) {
            if (data.urls && data.min_sec && data.max_sec) {
                var min_date = new Date(data.min_sec * 1000).toLocaleString();
                var max_date = new Date(data.max_sec * 1000).toLocaleString();
                $("#currLabel").html("Loaded <b>" + data.urls + " urls </b> spanning " + min_date + " - " + max_date);
                $(".rel_message").hide();
            }
            //if (sec) {
            //    $("#currLabel").html("Current Page: <b>" + url + "</b> from <b>" + new Date(sec * 1000).toGMTString() + "</b>");
            //}
            
            update_state();
        });
    }

    window.setInterval(ping, 5000);
    ping();
});
</script>
</body>
</html>
